<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Chore Manager</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<style>
    :root {
      --bg: #0a0e1a;
      --panel: #131827;
      --panel-2: #0d1220;
      --muted: #94a3b8;
      --text: #f1f5f9;
      --accent: #60a5fa;
      --accent-2: #a78bfa;
      --accent-3: #ec4899;
      --danger: #ef4444;
      --border: #1e293b;
      --border-light: #334155;
      --drop: #3b82f6;
      --success: #10b981;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background: 
        radial-gradient(1400px 700px at 15% -10%, rgba(96,165,250,0.15), transparent 65%),
        radial-gradient(1000px 1000px at 85% 15%, rgba(167,139,250,0.12), transparent 55%),
        radial-gradient(800px 800px at 50% 100%, rgba(236,72,153,0.08), transparent 50%),
        var(--bg);
      min-height: 100vh;
      background-attachment: fixed;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(12px) saturate(180%);
      background: linear-gradient(180deg, rgba(10,14,26,0.9), rgba(10,14,26,0.7));
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
    }
    header .wrap {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }
    .brand-badge {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2), var(--accent-3));
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 900;
      font-size: 18px;
      box-shadow: 0 8px 16px rgba(96,165,250,0.3), 0 0 40px rgba(167,139,250,0.2);
      animation: pulse 3s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .brand-text {
      font-size: 20px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hint {
      color: var(--muted);
      font-size: 12px;
      font-weight: 400;
    }

    main {
      max-width: 1400px;
      margin: 32px auto;
      padding: 0 20px 60px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      margin: 10% auto;
      padding: 32px;
      border: 1px solid var(--border-light);
      width: 90%;
      max-width: 520px;
      border-radius: 20px;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 80px rgba(96,165,250,0.1);
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    .close-btn {
      color: var(--muted);
      position: absolute;
      top: 16px;
      right: 20px;
      font-size: 32px;
      font-weight: bold;
      line-height: 1;
      transition: all 0.2s ease;
      cursor: pointer;
      width: 36px;
      height: 36px;
      display: grid;
      place-items: center;
      border-radius: 8px;
    }

    .close-btn:hover {
      color: var(--text);
      background: rgba(255,255,255,0.05);
      transform: rotate(90deg);
    }

    .modal h3 {
      margin: 0 0 24px;
      font-size: 24px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Controls */
    .controls {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 32px;
    }
    .card {
      background: linear-gradient(135deg, rgba(96,165,250,0.05), rgba(167,139,250,0.05));
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3));
    }
    .card h3 {
      margin: 0 0 16px;
      font-size: 18px;
      font-weight: 600;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      margin-bottom: 8px;
    }
    .row-3 {
      display: grid;
      grid-template-columns: 1fr 120px 220px auto;
      gap: 12px;
      align-items: center;
    }
    @media (max-width: 800px) {
      .row-3 {
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      #chore-form button {
        grid-column: 1 / -1;
      }
    }
    @media (max-width: 480px) {
      .row-3 {
        grid-template-columns: 1fr;
        gap: 12px;
      }
    }
    input, select, button {
      font: inherit;
    }
    input, select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(19,24,39,0.8);
      color: var(--text);
      outline: none;
      transition: all 0.2s ease;
      font-size: 15px;
    }
    input:focus, select:focus {
      border-color: var(--accent);
      background: rgba(19,24,39,1);
      box-shadow: 0 0 0 3px rgba(96,165,250,0.1);
    }
    input::placeholder { color: #64748b; }
    button {
      padding: 12px 20px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(96,165,250,0.3);
      position: relative;
      overflow: hidden;
    }
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }
    button:hover::before {
      left: 100%;
    }
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(96,165,250,0.4);
    }
    button:active { transform: translateY(0); }

    /* Board */
    .board {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .column {
      background: linear-gradient(135deg, rgba(19,24,39,0.8), rgba(13,18,32,0.9));
      border: 1px solid var(--border-light);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      min-height: 320px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .column:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }
    .column-header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: linear-gradient(135deg, rgba(96,165,250,0.08), rgba(167,139,250,0.08));
    }
    .column-header h4 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.3px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .column-header h4::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 12px rgba(96,165,250,0.6);
    }
    .count {
      color: var(--accent);
      font-size: 13px;
      padding: 4px 12px;
      border: 1px solid var(--border-light);
      border-radius: 999px;
      background: rgba(96,165,250,0.1);
      font-weight: 600;
    }
    .frequency-breakdown {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .freq-count {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 700;
      border: 1px solid;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .freq-count.daily {
      background: rgba(236,72,153,0.15);
      color: #f9a8d4;
      border-color: rgba(236,72,153,0.4);
    }
    .freq-count.weekly {
      background: rgba(96,165,250,0.15);
      color: #93c5fd;
      border-color: rgba(96,165,250,0.4);
    }
    .freq-count.monthly {
      background: rgba(167,139,250,0.15);
      color: #c4b5fd;
      border-color: rgba(167,139,250,0.4);
    }
    .dropzone {
      list-style: none;
      margin: 0;
      padding: 16px;
      flex: 1;
      overflow: auto;
      min-height: 240px;
      transition: all 0.3s ease;
    }
    .dropzone.over {
      background: radial-gradient(circle at center, rgba(59,130,246,0.15), transparent 70%);
      outline: 2px dashed var(--drop);
      outline-offset: -8px;
    }

    /* Chores */
    .chore {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      margin-bottom: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(96,165,250,0.08), rgba(167,139,250,0.08));
      cursor: grab;
      user-select: none;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      touch-action: none;
    }
    .chore::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, var(--accent), var(--accent-2));
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .chore:hover {
      border-color: var(--border-light);
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .chore:hover::before {
      opacity: 1;
    }
    .chore .title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
    }
    .chore.dragging { 
      opacity: 0.4;
      transform: scale(0.95);
    }
    .chore:active {
      cursor: grabbing;
    }
    .delete-btn, .delete-member-btn {
      background: rgba(239,68,68,0.1);
      color: #fca5a5;
      border: 1px solid rgba(239,68,68,0.3);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
      flex-shrink: 0;
    }
    .delete-btn:hover, .delete-member-btn:hover { 
      background: rgba(239,68,68,0.2);
      color: #fecaca;
      transform: scale(1.05);
    }
    .frequency-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
      border: 1px solid;
    }
    .frequency-badge:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .frequency-badge.daily {
      background: rgba(236,72,153,0.15);
      color: #f9a8d4;
      border-color: rgba(236,72,153,0.4);
    }
    .frequency-badge.weekly {
      background: rgba(96,165,250,0.15);
      color: #93c5fd;
      border-color: rgba(96,165,250,0.4);
    }
    .frequency-badge.monthly {
      background: rgba(167,139,250,0.15);
      color: #c4b5fd;
      border-color: rgba(167,139,250,0.4);
    }
    .footer-note {
      margin-top: 40px;
      color: var(--muted);
      font-size: 13px;
      text-align: center;
      opacity: 0.6;
    }
    .tiny {
      color: var(--muted);
      font-size: 13px;
      margin-top: 12px;
      line-height: 1.5;
    }
    #board { 
      transition: opacity 0.3s ease;
      animation: fadeInUp 0.5s ease;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Custom scrollbar */
    .dropzone::-webkit-scrollbar {
      width: 6px;
    }
    .dropzone::-webkit-scrollbar-track {
      background: transparent;
    }
    .dropzone::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 3px;
    }
    .dropzone::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* Print Styles */
    @media print {
      body {
        background: white;
        color: black;
      }
      header, .controls, .footer-note, .modal {
        display: none !important;
      }
      main {
        max-width: 100%;
        margin: 0;
        padding: 20px;
      }
      .board {
        display: block;
      }
      .column {
        page-break-inside: avoid;
        break-inside: avoid;
        margin-bottom: 30px;
        border: 2px solid #333;
        background: white;
        box-shadow: none;
      }
      .column-header {
        background: #f0f0f0;
        border-bottom: 2px solid #333;
        padding: 12px;
      }
      .column-header h4 {
        color: #000;
        font-size: 18px;
      }
      .column-header h4::before {
        background: #333;
      }
      .count {
        background: #e0e0e0;
        color: #333;
        border-color: #999;
      }
      .frequency-breakdown {
        display: flex;
        gap: 6px;
      }
      .freq-count {
        font-size: 10px;
        padding: 2px 6px;
        border: 1px solid;
      }
      .freq-count.daily {
        background: #ffe0f0;
        color: #c0006b;
        border-color: #c0006b;
      }
      .freq-count.weekly {
        background: #e0f0ff;
        color: #0066cc;
        border-color: #0066cc;
      }
      .freq-count.monthly {
        background: #f0e0ff;
        color: #6600cc;
        border-color: #6600cc;
      }
      .delete-member-btn {
        display: none;
      }
      .dropzone {
        padding: 12px;
      }
      .chore {
        background: white;
        border: 1px solid #666;
        margin-bottom: 8px;
        padding: 10px;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .chore::before {
        display: none;
      }
      .chore .title {
        color: #000;
        font-weight: 500;
      }
      .delete-btn {
        display: none;
      }
      .frequency-badge {
        border: 1px solid #666;
        padding: 3px 8px;
        font-size: 10px;
      }
      .frequency-badge.daily {
        background: #ffe0f0;
        color: #c0006b;
        border-color: #c0006b;
      }
      .frequency-badge.weekly {
        background: #e0f0ff;
        color: #0066cc;
        border-color: #0066cc;
      }
      .frequency-badge.monthly {
        background: #f0e0ff;
        color: #6600cc;
        border-color: #6600cc;
      }
      .print-header {
        display: block !important;
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 3px solid #333;
      }
      .print-header h1 {
        margin: 0 0 10px;
        font-size: 28px;
        color: #000;
      }
      .print-header .print-date {
        font-size: 14px;
        color: #666;
      }
    }
    .print-header {
      display: none;
    }
  </style>
<script>
                window.load_data_from_csv = (filename) => {
                    // Implementation needed when code is downloaded
                };

                window.save_data_to_csv = (filename, data) => {
                    // Implementation needed when code is downloaded
                };

                window.call_llm = (system_prompt, user_messages, json_fields) => {
                    // Implementation needed when code is downloaded
                };
            </script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script></head>
<body>
<header>
<div class="wrap">
      <div class="brand">
        <div class="brand-badge">C</div>
        <div>
          <div class="brand-text">Chore Manager</div>
          <div class="hint">‚ú® Organize, assign, and track household chores</div>
        </div>
      </div>
      <div style="display: flex; gap: 12px;">
        <button id="print-btn" title="Print chore list">üñ®Ô∏è Print</button>
        <button id="add-member-btn">+ Add Member</button>
      </div>
</div>
  </header>
  <main>
    <div class="print-header">
      <h1>üìã Chore Assignment List</h1>
      <div class="print-date"></div>
    </div>
    <section class="controls">
<div class="card">
<h3>üìã Add New Chore</h3>
<form autocomplete="off" id="chore-form">
<div class="row-3">
<input id="chore-title" placeholder="e.g., Clean the fridge" required="" type="text"/>
<select id="chore-frequency" aria-label="Chore frequency">
  <option value="daily">Daily</option>
  <option value="weekly" selected>Weekly</option>
  <option value="monthly">Monthly</option>
</select>
<select aria-label="Assign to" id="chore-assignee"></select>
<button type="submit">Add Chore</button>
</div>
</form>
<div class="tiny">üí° Drag chores between members to reassign. Click √ó to delete.</div>
</div>
</section>
<section aria-live="polite" class="board" id="board"></section>
<div class="footer-note">Made with ‚ù§Ô∏è by Sambosis</div>
</main>

<div id="add-member-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h3>üë§ Add New Member</h3>
    <form autocomplete="off" id="member-form">
      <div class="row">
        <input id="member-name" placeholder="e.g., Alex" required="" type="text"/>
        <button type="submit">Add</button>
      </div>
    </form>
    <div class="tiny">üí° Tip: Avoid duplicates. "Unassigned" is reserved.</div>
  </div>
</div>

<template id="column-template">
<div class="column" data-member-id="">
<div class="column-header">
<h4></h4>
<div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
<div class="frequency-breakdown"></div>
<button aria-label="Delete member" class="delete-member-btn">√ó</button>
</div>
</div>
<ul aria-label="Drop chores here" class="dropzone" role="list"></ul>
</div>
</template>
<template id="chore-template">
<li class="chore" data-id="" draggable="true" role="listitem" title="Drag to reassign">
<span class="title"></span>
<div style="display: flex; align-items: center; gap: 8px;">
<span class="frequency-badge" title="Click to change frequency"></span>
<button aria-label="Delete chore" class="delete-btn">√ó</button>
</div>
</li>
</template>
<script>
    (async function () {
      const defaultState = {
        members: [
          { id: "unassigned", name: "Unassigned" },
        ],
        chores: [
          { id: "c_ex1", title: "Wash dishes", memberId: "unassigned", frequency: "daily" },
          { id: "c_ex2", title: "Vacuum living room", memberId: "unassigned", frequency: "weekly" },
        ],
      };

      // --- Supabase Setup ---
      const SUPABASE_URL = 'https://xzutyacrdzmddbwtaqko.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6dXR5YWNyZHptZGRid3RhcWtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDI3NjEsImV4cCI6MjA3NTQ3ODc2MX0.NJh7DXVY3f-4zraoB8sD1ZJzynB_uLU9a5scOCzj0XA';
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const STATE_ID = 1;

      let state;

      // Elements
      const boardEl = document.getElementById("board");
      const memberForm = document.getElementById("member-form");
      const memberNameInput = document.getElementById("member-name");
      const choreForm = document.getElementById("chore-form");
      const choreTitleInput = document.getElementById("chore-title");
      const choreFrequencySelect = document.getElementById("chore-frequency");
      const choreAssigneeSelect = document.getElementById("chore-assignee");
      const colTpl = document.getElementById("column-template");
      const choreTpl = document.getElementById("chore-template");
      const addMemberModal = document.getElementById("add-member-modal");
      const addMemberBtn = document.getElementById("add-member-btn");
      const printBtn = document.getElementById("print-btn");
      const closeBtn = document.querySelector(".close-btn");


      // --- App Initialization ---
      (async function init() {
        boardEl.style.opacity = 0.5;

        state = await loadState() || defaultState;
        render();
        memberForm.addEventListener("submit", handleAddMember);
        choreForm.addEventListener("submit", handleAddChore);
        addMemberBtn.addEventListener("click", () => addMemberModal.style.display = "block");
        printBtn.addEventListener("click", handlePrint);
        closeBtn.addEventListener("click", () => addMemberModal.style.display = "none");
        window.addEventListener("click", (event) => {
          if (event.target == addMemberModal) {
            addMemberModal.style.display = "none";
          }
        });
        boardEl.style.opacity = 1;
      })();

      /* --- Actions --- */

      async function handleAddMember(e) {
        e.preventDefault();
        let name = (memberNameInput.value || "").trim();
        if (!name) return;

        if (name.toLowerCase() === "unassigned") {
          alert('"Unassigned" is reserved. Pick a different name.');
          return;
        }
        if (state.members.some(m => m.name.toLowerCase() === name.toLowerCase())) {
          alert("That member already exists.");
          return;
        }

        const idBase = slugify(name) || "member";
        let id = idBase;
        let i = 2;
        while (state.members.some(m => m.id === id)) {
          id = `${idBase}-${i++}`;
        }

        state.members.push({ id, name });
        await saveState();
        memberNameInput.value = "";
        addMemberModal.style.display = "none";
        render();
      }

      async function handleAddChore(e) {
        e.preventDefault();
        const title = (choreTitleInput.value || "").trim();
        if (!title) return;

        const memberId = choreAssigneeSelect.value || "unassigned";
        const frequency = choreFrequencySelect.value || "weekly";
        state.chores.push({ id: uid(), title, memberId, frequency });
        await saveState();

        choreTitleInput.value = "";
        choreAssigneeSelect.value = "unassigned";
        choreFrequencySelect.value = "weekly";
        render();
      }

      async function deleteChore(id) {
        state.chores = state.chores.filter(c => c.id !== id);
        await saveState();
        render();
      }

      async function deleteMember(id) {
        if (id === "unassigned") return;

        state.chores.forEach(c => {
          if (c.memberId === id) {
            c.memberId = "unassigned";
          }
        });

        state.members = state.members.filter(m => m.id !== id);
        await saveState();
        render();
      }

      async function moveChore(choreId, memberId) {
        const c = state.chores.find(x => x.id === choreId);
        if (!c) return;
        c.memberId = memberId;
        await saveState();
        render();
      }

      async function updateChoreFrequency(choreId) {
        const c = state.chores.find(x => x.id === choreId);
        if (!c) return;
        
        // Cycle through frequencies: daily -> weekly -> monthly -> daily
        const frequencies = ['daily', 'weekly', 'monthly'];
        const currentIndex = frequencies.indexOf(c.frequency || 'weekly');
        const nextIndex = (currentIndex + 1) % frequencies.length;
        c.frequency = frequencies[nextIndex];
        
        await saveState();
        render();
      }

      function handlePrint() {
        // Update print date
        const printDateEl = document.querySelector('.print-date');
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        printDateEl.textContent = `Generated on ${dateStr}`;
        
        // Trigger print dialog
        window.print();
      }

      /* --- Render --- */

      function render() {
        boardEl.innerHTML = "";
        state.members.forEach(member => {
          const node = colTpl.content.firstElementChild.cloneNode(true);
          node.dataset.memberId = member.id;
          node.querySelector("h4").textContent = member.name;

          const deleteBtn = node.querySelector(".delete-member-btn");
          if (member.id === "unassigned") {
            deleteBtn.remove();
          } else {
            deleteBtn.addEventListener("click", () => deleteMember(member.id));
          }

          const dropzone = node.querySelector(".dropzone");
          dropzone.dataset.memberId = member.id;

          const chores = state.chores.filter(c => c.memberId === member.id);
          
          // Sort chores by frequency: daily -> weekly -> monthly
          const frequencyOrder = { 'daily': 1, 'weekly': 2, 'monthly': 3 };
          chores.sort((a, b) => {
            const orderA = frequencyOrder[a.frequency || 'weekly'] || 2;
            const orderB = frequencyOrder[b.frequency || 'weekly'] || 2;
            return orderA - orderB;
          });
          
          // Calculate frequency breakdown
          const dailyCount = chores.filter(c => c.frequency === 'daily').length;
          const weeklyCount = chores.filter(c => c.frequency === 'weekly').length;
          const monthlyCount = chores.filter(c => c.frequency === 'monthly').length;
          
          // Update frequency breakdown display
          const breakdownEl = node.querySelector(".frequency-breakdown");
          breakdownEl.innerHTML = '';
          
          if (dailyCount > 0) {
            const dailyBadge = document.createElement('span');
            dailyBadge.className = 'freq-count daily';
            dailyBadge.innerHTML = `<span>D:</span><span>${dailyCount}</span>`;
            dailyBadge.title = `${dailyCount} Daily chore${dailyCount !== 1 ? 's' : ''}`;
            breakdownEl.appendChild(dailyBadge);
          }
          
          if (weeklyCount > 0) {
            const weeklyBadge = document.createElement('span');
            weeklyBadge.className = 'freq-count weekly';
            weeklyBadge.innerHTML = `<span>W:</span><span>${weeklyCount}</span>`;
            weeklyBadge.title = `${weeklyCount} Weekly chore${weeklyCount !== 1 ? 's' : ''}`;
            breakdownEl.appendChild(weeklyBadge);
          }
          
          if (monthlyCount > 0) {
            const monthlyBadge = document.createElement('span');
            monthlyBadge.className = 'freq-count monthly';
            monthlyBadge.innerHTML = `<span>M:</span><span>${monthlyCount}</span>`;
            monthlyBadge.title = `${monthlyCount} Monthly chore${monthlyCount !== 1 ? 's' : ''}`;
            breakdownEl.appendChild(monthlyBadge);
          }

          chores.forEach(c => {
            const li = choreTpl.content.firstElementChild.cloneNode(true);
            li.dataset.id = c.id;
            li.querySelector(".title").textContent = c.title;

            // Set frequency badge
            const frequencyBadge = li.querySelector(".frequency-badge");
            const frequency = c.frequency || 'weekly';
            frequencyBadge.textContent = frequency.charAt(0).toUpperCase() + frequency.slice(1);
            frequencyBadge.className = `frequency-badge ${frequency}`;
            frequencyBadge.addEventListener("click", (e) => {
              e.stopPropagation();
              updateChoreFrequency(c.id);
            });

            // Desktop drag-and-drop
            li.addEventListener("dragstart", onDragStart);
            li.addEventListener("dragend", onDragEnd);

            // Mobile touch support
            li.addEventListener("touchstart", onTouchStart, { passive: false });
            li.addEventListener("touchmove", onTouchMove, { passive: false });
            li.addEventListener("touchend", onTouchEnd);

            li.querySelector(".delete-btn").addEventListener("click", () => deleteChore(c.id));

            dropzone.appendChild(li);
          });

          dropzone.addEventListener("dragover", onDragOver);
          dropzone.addEventListener("dragleave", onDragLeave);
          dropzone.addEventListener("drop", onDrop);

          boardEl.appendChild(node);
        });

        renderAssigneeSelect();
      }

      function renderAssigneeSelect() {
        choreAssigneeSelect.innerHTML = "";
        state.members.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = m.name;
          choreAssigneeSelect.appendChild(opt);
        });
        if (!choreAssigneeSelect.value) {
          choreAssigneeSelect.value = "unassigned";
        }
      }

      /* --- DnD --- */

      function onDragStart(e) {
        const id = e.currentTarget.dataset.id;
        e.dataTransfer.setData("text/plain", id);
        e.dataTransfer.effectAllowed = "move";
        e.currentTarget.classList.add("dragging");
      }
      function onDragEnd(e) {
        e.currentTarget.classList.remove("dragging");
      }
      function onDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        e.currentTarget.classList.add("over");
      }
      function onDragLeave(e) {
        e.currentTarget.classList.remove("over");
      }
      async function onDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove("over");

        const choreId = e.dataTransfer.getData("text/plain");
        const memberId = e.currentTarget.dataset.memberId;
        if (!choreId || !memberId) return;

        await moveChore(choreId, memberId);
      }

      /* --- Touch Support for Mobile --- */
      let touchState = {
        choreId: null,
        element: null,
        clone: null,
        startX: 0,
        startY: 0,
        currentDropzone: null
      };

      function onTouchStart(e) {
        const chore = e.currentTarget;
        const touch = e.touches[0];
        
        touchState.choreId = chore.dataset.id;
        touchState.element = chore;
        touchState.startX = touch.clientX;
        touchState.startY = touch.clientY;
        
        // Create a clone for dragging
        const clone = chore.cloneNode(true);
        clone.style.position = 'fixed';
        clone.style.zIndex = '1000';
        clone.style.pointerEvents = 'none';
        clone.style.opacity = '0.8';
        clone.style.width = chore.offsetWidth + 'px';
        clone.style.left = touch.clientX - chore.offsetWidth / 2 + 'px';
        clone.style.top = touch.clientY - 30 + 'px';
        document.body.appendChild(clone);
        touchState.clone = clone;
        
        chore.classList.add('dragging');
        e.preventDefault();
      }

      function onTouchMove(e) {
        if (!touchState.clone) return;
        
        const touch = e.touches[0];
        touchState.clone.style.left = touch.clientX - touchState.clone.offsetWidth / 2 + 'px';
        touchState.clone.style.top = touch.clientY - 30 + 'px';
        
        // Find dropzone under touch
        const dropzones = document.querySelectorAll('.dropzone');
        let foundDropzone = null;
        
        dropzones.forEach(zone => {
          const rect = zone.getBoundingClientRect();
          if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
              touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
            foundDropzone = zone;
          }
        });
        
        // Update visual feedback
        dropzones.forEach(zone => zone.classList.remove('over'));
        if (foundDropzone) {
          foundDropzone.classList.add('over');
          touchState.currentDropzone = foundDropzone;
        } else {
          touchState.currentDropzone = null;
        }
        
        e.preventDefault();
      }

      async function onTouchEnd(e) {
        if (!touchState.clone) return;
        
        // Remove clone
        document.body.removeChild(touchState.clone);
        touchState.element.classList.remove('dragging');
        
        // Clear all over states
        document.querySelectorAll('.dropzone').forEach(zone => zone.classList.remove('over'));
        
        // Handle drop
        if (touchState.currentDropzone && touchState.choreId) {
          const memberId = touchState.currentDropzone.dataset.memberId;
          if (memberId) {
            await moveChore(touchState.choreId, memberId);
          }
        }
        
        // Reset state
        touchState = {
          choreId: null,
          element: null,
          clone: null,
          startX: 0,
          startY: 0,
          currentDropzone: null
        };
      }

      /* --- Storage & Utils --- */

      async function loadState() {
        try {
          const { data, error } = await supabaseClient
            .from('app_state')
            .select('data')
            .eq('id', STATE_ID)
            .single();

          if (error && error.code !== 'PGRST116') {
            throw error;
          }
          if (!data) {
            console.log("No existing state found, will use default.");
            return null;
          }
          
          // Ensure all chores have a frequency (backward compatibility)
          const loadedState = data.data;
          if (loadedState && loadedState.chores) {
            loadedState.chores.forEach(chore => {
              if (!chore.frequency) {
                chore.frequency = 'weekly';
              }
            });
          }
          
          return loadedState;
        } catch (err) {
          console.error("Error loading state:", err);
          return null;
        }
      }

      async function saveState() {
        try {
          const { error } = await supabaseClient
            .from('app_state')
            .upsert({ id: STATE_ID, data: state });
          if (error) throw error;
        } catch (err) {
          console.error("Error saving state:", err);
        }
      }
      function uid() {
        return "c_" + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
      }
      function slugify(s) {
        return s.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
      }
    }());
  </script>
</body>
</html>